<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Portal Fiscal NEXA IA</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/dashboard.css') }}">
</head>
<body>
    <div class="dashboard-container">
        <header class="header">
            <h1>üìä Portal Fiscal NEXA IA</h1>
            <button class="logout-btn" id="logoutBtn">Sair</button>
        </header>

        <main class="main-content">
            <section class="empresa-info">
                <h2>üè¢ Dados da Empresa</h2>
                <p><strong>Nome:</strong> <span id="nomeEmpresa">Carregando...</span></p>
                <p><strong>Regime Tribut√°rio:</strong> <span id="regimeEmpresa">Carregando...</span></p>
                <p><strong>Natureza Jur√≠dica:</strong> <span id="naturezaEmpresa">Carregando...</span></p>
                <p><strong>RBT12 (√∫ltimos 12 meses):</strong> <span id="rbt12">Carregando...</span>
                <input type="number" id="rbt12Input" placeholder="Ex: 500000.00" step="0.01">
                <button onclick="salvarRBT12()">Salvar</button></p>
            </section>

            <section class="acoes">
                <button id="uploadBtn" class="action-btn">üìÅ Enviar Notas Fiscais</button>
                <button id="chatBtn" class="action-btn">üí¨ Chat com IA Fiscal</button>
            </section>

            <section id="uploadSection" class="upload-section hidden">
                <h2>üìÇ Upload de Notas</h2>
                <form id="uploadForm" enctype="multipart/form-data">
                    <input type="file" id="fileInput" name="files" multiple accept=".pdf,.xml,.csv">
                    <input type="text" id="apiKey" placeholder="Insira sua chave de API Gemini/Grok">
                    <button type="submit">Enviar</button>
                </form>
                <div id="uploadStatus"></div>
            </section>
        </main>
    </div>

<script>
    document.getElementById("logoutBtn").addEventListener("click", async () => {
        const res = await fetch("/logout", { method: "POST" });
        if (res.ok) window.location.href = "/";
    });

    document.getElementById("uploadBtn").addEventListener("click", () => {
        document.getElementById("uploadSection").classList.toggle("hidden");
    });

    document.getElementById("chatBtn").addEventListener("click", () => {
        window.location.href = "/chat";
    });

    // Carrega dados da empresa logada + RBT12 (CORRIGIDO: fetch primeiro, json depois)
    window.onload = async () => {
        try {
            const res = await fetch("/api/usuario_dados");  // CORRIGIDO: fetch antes de json
            const data = await res.json();  // Agora res √© response
            document.getElementById("nomeEmpresa").textContent = data.nome || "‚Äî";
            document.getElementById("regimeEmpresa").textContent = data.regime || "‚Äî";
            document.getElementById("naturezaEmpresa").textContent = data.natureza || "‚Äî";
            // RBT12: Formata como moeda BR
            const rbt12Value = data.rbt12 || 0;
            document.getElementById("rbt12").textContent = `R$ ${rbt12Value.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById("rbt12Input").value = rbt12Value;
        } catch (e) {
            console.error("Erro ao carregar dados:", e);  // Debug no console F12
            // Fallback se falhar
            document.getElementById("nomeEmpresa").textContent = "‚Äî";
            document.getElementById("regimeEmpresa").textContent = "‚Äî";
            document.getElementById("naturezaEmpresa").textContent = "‚Äî";
            document.getElementById("rbt12").textContent = "R$ 0,00";
        }
    };

    // Handler para upload de arquivos (igual antes)
    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
        e.preventDefault();  // Impede submit padr√£o

        const files = document.getElementById("fileInput").files;
        const apiKey = document.getElementById("apiKey").value.trim();
        const statusDiv = document.getElementById("uploadStatus");

        if (files.length === 0) {
            statusDiv.innerHTML = '<p style="color: red;">Selecione pelo menos um arquivo!</p>';
            return;
        }
        if (!apiKey) {
            statusDiv.innerHTML = '<p style="color: red;">Insira a chave de API!</p>';
            return;
        }

        statusDiv.innerHTML = '<p>Enviando... Aguarde.</p>';  // Loading

        const formData = new FormData();
        for (let file of files) {
            formData.append("files", file);  // Nome "files" pro backend
        }
        formData.append("api_key", apiKey);  // "api_key" em snake_case

        try {
            const res = await fetch("/api/process-documents", {  // Rota real
                method: "POST",
                body: formData  // Multipart autom√°tico
            });

            const data = await res.json();

            if (res.ok) {
                statusDiv.innerHTML = `<p style="color: green;">Sucesso! ${data.mensagem || 'Arquivos processados.'}</p>`;
                // Para m√∫ltiplos arquivos, mostra detalhes
                if (Array.isArray(data)) {
                    let html = '<ul>';
                    data.forEach(item => html += `<li>${item.arquivo}: ${item.status}</li>`);
                    html += '</ul>';
                    statusDiv.innerHTML += html;
                }
                document.getElementById("uploadForm").reset();  // Limpa o form
            } else {
                statusDiv.innerHTML = `<p style="color: red;">Erro: ${data.erro || 'Falha no processamento.'}</p>`;
            }
        } catch (error) {
            statusDiv.innerHTML = `<p style="color: red;">Erro de conex√£o: ${error.message}</p>`;
            console.error("Erro no upload:", error);
        }
    });

    // NOVO: Fun√ß√£o salvar RBT12
    async function salvarRBT12() {
        const rbt12Input = document.getElementById("rbt12Input").value;
        const rbt12 = parseFloat(rbt12Input);
        if (isNaN(rbt12) || rbt12 < 0) {
            alert("RBT12 deve ser um n√∫mero positivo!");
            return;
        }
        try {
            const res = await fetch("/api/atualizar_rbt12", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({rbt12})
            });
            const data = await res.json();
            if (res.ok) {
                alert("RBT12 salvo com sucesso!");
                // Atualiza span local
                document.getElementById("rbt12").textContent = `R$ ${rbt12.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            } else {
                alert("Erro: " + data.erro);
            }
        } catch (error) {
            alert("Erro de conex√£o: " + error.message);
            console.error("Erro salvar RBT12:", error);
        }
    }
</script>
</body>
</html>